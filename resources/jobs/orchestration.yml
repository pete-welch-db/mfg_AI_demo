# Single orchestration job: notebooks + DLT pipeline in sequence (no job-calls-job).
# All notebook tasks use serverless compute; pipeline task uses DLT pipeline compute.
# Run: databricks bundle run -t dev mfg_demo_orchestration
resources:
  jobs:
    mfg_demo_orchestration:
      name: mfg_demo_orchestration
      queue:
        enabled: true
      schedule:
        quartz_cron_expression: "0 0 6 * * ?"
        timezone_id: "America/Chicago"
      tasks:
        - task_key: generate_bronze
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/01_generate_bronze
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"

        - task_key: run_dlt
          depends_on:
            - task_key: generate_bronze
          pipeline_task:
            pipeline_id: ${resources.pipelines.mfg_demo_dlt_medallion.id}
            full_refresh: false

        - task_key: ml_training
          depends_on:
            - task_key: run_dlt
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/03_ml_training
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"

        - task_key: uc_metrics
          depends_on:
            - task_key: ml_training
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/07_uc_metrics
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"

        - task_key: lakehouse_monitoring
          depends_on:
            - task_key: run_dlt
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/05_lakehouse_monitoring
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"

        - task_key: alert_kpi
          depends_on:
            - task_key: uc_metrics
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/06_alerts_kpi
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"

        - task_key: refresh_dashboard
          depends_on:
            - task_key: uc_metrics
          dashboard_task:
            subscription: {}
            warehouse_id: ${var.warehouse_id}
            dashboard_id: ${resources.dashboards.mfg_demo_operations.id}
