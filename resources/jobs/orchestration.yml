# Single orchestration job: data → gold → ML → UC metrics → monitoring → alerts → dashboard refresh.
# Run after deploy: databricks bundle run -t dev mfg_demo_orchestration
# Or trigger from workspace: Bundle → run job mfg_demo_orchestration.
resources:
  jobs:
    mfg_demo_orchestration:
      name: mfg_demo_orchestration
      tasks:
        - task_key: generate_bronze
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/01_generate_bronze
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
          job_cluster_key: job_cluster

        - task_key: run_dlt
          depends_on:
            - task_key: generate_bronze
          pipeline_task:
            pipeline_id: ${resources.pipelines.mfg_demo_dlt_medallion.id}
            full_refresh: false

        - task_key: ml_training
          depends_on:
            - task_key: run_dlt
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/03_ml_training
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
          job_cluster_key: job_cluster

        - task_key: uc_metrics
          depends_on:
            - task_key: ml_training
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/07_uc_metrics
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
          job_cluster_key: job_cluster

        - task_key: lakehouse_monitoring
          depends_on:
            - task_key: run_dlt
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/05_lakehouse_monitoring
          job_cluster_key: job_cluster

        - task_key: alert_kpi
          depends_on:
            - task_key: uc_metrics
          notebook_task:
            notebook_path: ${workspace.file_path}/notebooks/06_alerts_kpi
            base_parameters:
              catalog: "${var.catalog}"
              schema: "${var.schema}"
          job_cluster_key: job_cluster

        - task_key: refresh_dashboard
          depends_on:
            - task_key: uc_metrics
          dashboard_task:
            dashboard_id: ${resources.dashboards.mfg_demo_operations.id}
            warehouse_id: ${var.warehouse_id}

      job_clusters:
        - job_cluster_key: job_cluster
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 0
            spark_env_vars:
              DEMO_CATALOG: "${var.catalog}"
              DEMO_SCHEMA: "${var.schema}"
